<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Auth GIS y Publicación en Blogger</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const CLIENT_ID = "338010031407-a0qku90nm9atgjsgirdg9i40av85ptbn.apps.googleusercontent.com";
    const API_KEY = "AIzaSyBkROi9aAkTcWaZwMa05RG7dFPbwdrZIok";
    const BLOG_ID = "6423620772115300042";
    const SCOPES = "https://www.googleapis.com/auth/blogger";

    // Callback para manejar la respuesta del token
    function handleCredentialResponse(response) {
      console.log("ID token: " + response.credential);
      alert("Autenticación exitosa. ID token: " + response.credential);
      initializeBloggerAPI(response.credential);
    }

    window.onload = function () {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse,
      });

      google.accounts.id.renderButton(
        document.getElementById("buttonDiv"),
        { theme: "outline", size: "large" }
      );

      google.accounts.id.prompt();
    };

    function initializeBloggerAPI(idToken) {
      gapi.load('client', () => {
        gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/blogger/v3/rest"]
        }).then(() => {
          // Verify the token and get the user's information
          gapi.client.request({
            path: `https://oauth2.googleapis.com/tokeninfo?id_token=${idToken}`
          }).then(response => {
            const userEmail = response.result.email;
            console.log("User email:", userEmail);

            // Check if the user has access to the blog
            gapi.client.blogger.blogs.get({
              blogId: BLOG_ID
            }).then(blogResponse => {
              const blogAuthors = blogResponse.result.users;
              if (blogAuthors.includes(userEmail)) {
                document.getElementById('post-button').disabled = false;
              } else {
                alert("El usuario autenticado no tiene permisos para publicar en este blog.");
              }
            }).catch(err => {
              console.error("Error al obtener el blog:", err);
              alert("Error al obtener el blog: " + err.result.error.message);
            });
          }).catch(err => {
            console.error("Error al verificar el token:", err);
            alert("Error al verificar el token: " + err.result.error.message);
          });
        }).catch(err => {
          console.error("Error al inicializar Blogger API", err);
        });
      });
    }

    function makeApiCall() {
      const postContent = {
        kind: "blogger#post",
        title: "Título del Blog desde JS",
        content: "<p>Contenido del blog generado desde JavaScript</p>"
      };

      gapi.client.blogger.posts.insert({
        blogId: BLOG_ID,
        resource: postContent
      }).then(response => {
        alert("Entrada publicada con éxito: " + response.result.url);
      }).catch(err => {
        console.error("Error al publicar:", err);
        alert("Error al publicar la entrada: " + err.result.error.message);
      });
    }
  </script>
</head>
<body>
  <h1>Autenticación con Google GIS y Publicación en Blogger</h1>
  <div id="buttonDiv"></div>
  <button id="post-button" disabled onclick="makeApiCall()">Publicar Blog</button>
</body>
</html>
